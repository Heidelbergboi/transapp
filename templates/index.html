<script>
async function upload () {
  const file   = document.getElementById('file').files[0];
  const parts  = document.getElementById('parts').value || 5;
  const log    = t => (document.getElementById('log').textContent += t + '\n');

  if (!file) { alert('Zgjidhni një MP4'); return; }

  /* 1) presign ---------------------------------------------------- */
  log('🚦 /sign …');
  const sign = await fetch('/sign', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: file.name })
      }).then(r => r.json());

  /* 2) direct POST to S3 (with progress) -------------------------- */
  const fd = new FormData();
  Object.entries(sign.fields).forEach(([k, v]) => fd.append(k, v));
  fd.append('file', file);                         // MUST be last

  log(`⬆️  Uploading ${prettyBytes(file.size)} to S3…`);
  await new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', sign.url, true);

    xhr.upload.onprogress = ev => {
      if (!ev.lengthComputable) return;
      const pct = (ev.loaded / ev.total * 100).toFixed(1);
      log(`   … ${pct}% (${prettyBytes(ev.loaded)} / ${prettyBytes(ev.total)})`);
    };

    xhr.onload  = () => xhr.status === 204 ? resolve() :
                               reject(new Error(`S3 upload failed – HTTP ${xhr.status}`));
    xhr.onerror = () => reject(new Error('network error during S3 upload'));
    xhr.send(fd);
  });
  log('✅ Upload complete');

  /* 3) start the background job ---------------------------------- */
  log('🚦 /start-job …');
  const j = await fetch('/start-job', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ s3_key: sign.s3_key, parts })
      }).then(r => r.json());

  window.location = j.stream;                      // live log page
}

/* helper ― tiny human-readable byte formatter ---------------------- */
function prettyBytes (num) {
  if (num < 1024) return num + ' B';
  const units = ['KB', 'MB', 'GB', 'TB'];
  let i = -1;
  do { num /= 1024; ++i; } while (num >= 1024 && i < units.length - 1);
  return num.toFixed(1) + ' ' + units[i];
}
</script>
