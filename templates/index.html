<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="utf-8">
  <title>TransApp – Dritare.tv</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>body{background:#f8f9fa}.brand{color:#c41e3a;font-weight:700}</style>
</head>
<body class="py-5">
<div class="container">
  <h1 class="brand mb-4">TransApp</h1>

  <div class="card p-4 shadow-sm">
    <div class="mb-3">
      <input type="file" id="file" accept="video/mp4" class="form-control">
    </div>
    <div class="mb-3">
      <label class="form-label">Numri i pjesëve</label>
      <input type="number" id="parts" class="form-control" min="2" value="5">
    </div>
    <button class="btn btn-danger w-100" onclick="upload()">Starto</button>
  </div>

  <pre id="log" class="mt-4"></pre>
</div>

<script>
async function upload(){
  const f=document.getElementById('file').files[0];
  if(!f){alert("Zgjidhni një MP4");return;}
  const logEl=x=>document.getElementById('log').textContent+=x+"\n";

  /* 1. presign */
  logEl("Marr URL-në e ngarkimit…");
  const sign=await fetch("/sign",{method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({filename:f.name})
  }).then(r=>r.json());

  /* 2. POST direkt në S3 */
  const fd=new FormData();
  Object.entries(sign.fields).forEach(([k,v])=>fd.append(k,v));
  fd.append("Content-Type","video/mp4");
  fd.append("file",f);
  logEl("Ngarkim direkt në S3…");
  await fetch(sign.url,{method:"POST",body:fd});
  logEl("✅ Upload përfundoi");

  /* 3. nis job-in */
  const start=await fetch("/start-job",{method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({s3_key:sign.s3_key,parts:document.getElementById('parts').value})
  }).then(r=>r.json());

  /* 4. ridrejtohu te stream-i */
  window.location=start.stream;
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
